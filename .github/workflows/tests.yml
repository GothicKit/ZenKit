name: Test

on: 
  push:
  pull_request:
  release:

jobs:
  test:
    name: 'Test'
    runs-on: 'ubuntu-latest'
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
        with:
          submodules: 'recursive'
      - name: Setup
        run: |
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get install ninja-build cmake g++-11 libasan6
          ninja --version
          cmake --version
          g++-11 --version
      - name: Configure
        shell: bash
        env:
          CC: '/usr/bin/gcc-11'
          CXX: '/usr/bin/g++-11'
        run: |
          mkdir target
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -G "Ninja" \
            -DCMAKE_INSTALL_PREFIX:PATH=target \
            -DPX_BUILD_EXAMPLES=ON
      - name: Build
        shell: bash
        run: cmake --build build
      - name: Test
        shell: bash
        run: |
          cd tests
          ./../build/phoenix-tests -tse=messages,script,world -r=junit -o=report.xml
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v3
        if: always()
        with:
          report_paths: 'tests/report.xml'
